<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Presence++ Professional</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #3b82f6;
            --primary-dark: #2563eb;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --background-color: #f8fafc;
            --card-background: #ffffff;
            --text-color: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --gradient-primary: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            --gradient-success: linear-gradient(135deg, var(--success-color) 0%, #059669 100%);
            --gradient-danger: linear-gradient(135deg, var(--danger-color) 0%, #dc2626 100%);
        }

        /* Dark mode variables */
        [data-theme="dark"] {
            --background-color: #0f172a;
            --card-background: #1e293b;
            --text-color: #f8fafc;
            --text-secondary: #94a3b8;
            --border-color: #334155;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.4);
            --hover-color: #3b82f6;
            --shadow-color: rgba(0, 0, 0, 0.3);
        }

        /* Dark mode transitions */
        body, .sidebar, .content-section, .top-nav, .device-card, 
        .stat-card, .summary-card, .filter-btn, .students-table,
        .history-table, input, select, button {
            transition: all 0.3s ease;
        }

        /* Dark mode specific styles */
        [data-theme="dark"] .sidebar {
            background-color: var(--card-background);
            border-right: 1px solid var(--border-color);
            box-shadow: 2px 0 10px var(--shadow-color);
        }

        [data-theme="dark"] .content-section {
            background-color: var(--card-background);
            box-shadow: 0 2px 10px var(--shadow-color);
        }

        [data-theme="dark"] .top-nav {
            background-color: var(--card-background);
            box-shadow: 0 2px 10px var(--shadow-color);
        }

        [data-theme="dark"] .device-card {
            background-color: var(--card-background);
            box-shadow: 0 2px 10px var(--shadow-color);
        }

        [data-theme="dark"] .stat-card {
            background-color: var(--card-background);
            box-shadow: 0 2px 10px var(--shadow-color);
        }

        [data-theme="dark"] .nav-section h4 {
            color: #94a3b8;
        }

        [data-theme="dark"] .students-table th,
        [data-theme="dark"] .history-table th {
            background-color: var(--background-color);
            color: #94a3b8;
        }

        [data-theme="dark"] input,
        [data-theme="dark"] select {
            background-color: var(--background-color);
            color: var(--text-color);
            border-color: var(--border-color);
        }

        [data-theme="dark"] input:focus,
        [data-theme="dark"] select:focus {
            border-color: var(--hover-color);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        [data-theme="dark"] .filter-btn {
            background-color: var(--background-color);
            color: var(--text-color);
        }

        [data-theme="dark"] .filter-btn.active {
            background-color: var(--hover-color);
            color: white;
        }

        [data-theme="dark"] .nav-item:hover {
            background-color: var(--hover-color);
        }

        [data-theme="dark"] .summary-card {
            box-shadow: 0 2px 10px var(--shadow-color);
        }

        [data-theme="dark"] .date-range-picker {
            background-color: var(--card-background);
            box-shadow: 0 2px 10px var(--shadow-color);
        }

        [data-theme="dark"] .button-group button {
            box-shadow: 0 2px 5px var(--shadow-color);
        }

        [data-theme="dark"] .button-group button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--shadow-color);
        }

        [data-theme="dark"] .save-settings {
            background-color: var(--hover-color);
        }

        [data-theme="dark"] .save-settings:hover {
            background-color: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--shadow-color);
        }

        [data-theme="dark"] .status-badge {
            box-shadow: 0 2px 5px var(--shadow-color);
        }

        [data-theme="dark"] .status-badge.present {
            background-color: #16a34a;
        }

        [data-theme="dark"] .status-badge.absent {
            background-color: #dc2626;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            font-family: 'Poppins', sans-serif;
            line-height: 1.6;
        }

        #dashboard {
            display: grid;
            grid-template-columns: 280px 1fr;
            min-height: 100vh;
        }

        .sidebar {
            width: 280px;
            background-color: var(--card-background);
            padding: 20px;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }

        .sidebar-header {
            text-align: center;
            padding: 20px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-logo {
            width: 100px;
            height: 100px;
            margin-bottom: 10px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .college-logo {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .header-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            padding: 10px;
        }

        [data-theme="dark"] .logo-text {
            color: var(--text-color);
        }

        .nav-section {
            margin-top: 30px;
        }

        .nav-section h4 {
            color: #64748b;
            font-size: 14px;
            margin-bottom: 15px;
            padding-left: 10px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            color: var(--text-color);
            text-decoration: none;
            border-radius: 8px;
            margin-bottom: 5px;
            transition: all 0.3s ease;
        }

        .nav-item:hover, .nav-item.active {
            background-color: var(--primary-color);
            color: white;
        }

        .nav-item i {
            margin-right: 10px;
            font-size: 20px;
        }

        /* Update main content styles */
        .main-content {
            padding: 2rem;
            background-color: var(--background-color);
            position: relative;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Enhanced Top Navigation Bar */
        .top-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding: 1rem 2rem;
            background: linear-gradient(135deg, var(--primary-color) 0%, #1e40af 100%);
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 1rem;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .datetime-display {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.95rem;
            font-weight: 500;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .button-group {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .home-button,
        .export-button,
        .logout-button {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.7rem 1.2rem;
            border-radius: 8px;
            font-weight: 500;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            cursor: pointer;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .home-button {
            background: rgba(255, 255, 255, 0.1);
        }

        .export-button {
            background: rgba(34, 197, 94, 0.2);
        }

        .logout-button {
            background: rgba(239, 68, 68, 0.2);
        }

        .home-button:hover,
        .export-button:hover,
        .logout-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .home-button:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .export-button:hover {
            background: rgba(34, 197, 94, 0.3);
        }

        .logout-button:hover {
            background: rgba(239, 68, 68, 0.3);
        }

        .home-button i,
        .export-button i,
        .logout-button i {
            font-size: 1.1rem;
        }

        /* Add button press effect */
        .home-button:active,
        .export-button:active,
        .logout-button:active {
            transform: translateY(1px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        /* Responsive adjustments for top nav */
        @media (max-width: 768px) {
            .top-nav {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }

            .nav-right {
                width: 100%;
                justify-content: space-between;
            }

            .button-group {
                width: 100%;
                justify-content: center;
            }

            .datetime-display {
                width: 100%;
                text-align: center;
            }

            .home-button,
            .export-button,
            .logout-button {
                padding: 0.6rem 1rem;
                font-size: 0.9rem;
            }
        }

        /* Update content section styles */
        .content-section {
            width: 100%;
            max-width: 1200px;
            margin: 2rem auto;
            background-color: var(--card-background);
            padding: 2.5rem;
            border-radius: 20px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
        }

        .content-section h2 {
            text-align: center;
            margin-bottom: 2rem;
            color: var(--primary-color);
            font-size: 1.8rem;
            font-weight: 600;
            position: relative;
            padding-bottom: 1rem;
        }

        .content-section h2:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 3px;
            background: linear-gradient(to right, var(--primary-color), #1e40af);
            border-radius: 2px;
        }

        .esp32-status {
            margin-bottom: 30px;
        }

        .device-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 2rem;
            background-color: var(--card-background);
            border-radius: 16px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            margin: 2rem auto;
            max-width: 800px;
            width: 100%;
            border: 1px solid var(--border-color);
        }

        .device-info {
            display: flex;
            align-items: center;
        }

        .status-icon {
            font-size: 24px;
            margin-right: 15px;
            color: var(--success-color);
        }

        /* Update attendance summary grid */
        .attendance-summary {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2rem;
            margin: 2rem auto;
            max-width: 1000px;
            width: 100%;
        }

        .summary-card {
            padding: 2rem;
            border-radius: 16px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1.5rem;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, var(--primary-color) 0%, #1e40af 100%);
        }

        .summary-card.present {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .summary-card.absent {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        /* Update list filters */
        .list-filters {
            display: flex;
            gap: 1rem;
            margin: 1.5rem auto;
            justify-content: center;
            width: 100%;
            max-width: 600px;
        }

        .filter-btn {
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: 500;
            transition: all 0.3s ease;
            background: var(--card-background);
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }

        .filter-btn.active {
            background: linear-gradient(135deg, var(--primary-color) 0%, #1e40af 100%);
            color: white;
            border-color: var(--primary-color);
        }

        /* Update students table */
        .students-table {
            width: 100%;
            max-width: 1200px;
            margin: 2rem auto;
            background-color: var(--card-background);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .students-table th {
            background: linear-gradient(135deg, var(--primary-color) 0%, #1e40af 100%);
            color: white;
            padding: 1.2rem 1.5rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .students-table td {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .students-table tr:hover td {
            background-color: rgba(59, 130, 246, 0.05);
        }

        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
            color: white;
        }

        .status-badge.present {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .status-badge.absent {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .home-button {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .home-button:hover {
            background-color: #1d4ed8;
        }

        .export-button {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background-color: var(--success-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 10px;
        }

        .export-button:hover {
            background-color: #16a34a;
        }

        .button-group {
            display: flex;
            align-items: center;
        }

        /* Date Range Picker Styles */
        .date-range-picker {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
            background-color: var(--card-background);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .date-range-picker input {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-family: 'Poppins', sans-serif;
        }

        /* Statistics Cards */
        .statistics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background-color: var(--card-background);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .stat-card h3 {
            color: var(--text-color);
            margin-bottom: 10px;
            font-size: 16px;
        }

        .stat-card .value {
            font-size: 24px;
            font-weight: 600;
            color: var(--primary-color);
        }

        /* Settings Form */
        .settings-form {
            max-width: 600px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-color);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-family: 'Poppins', sans-serif;
        }

        .save-settings {
            background-color: var(--primary-color);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .save-settings:hover {
            background-color: #1d4ed8;
        }

        /* History Table */
        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .history-table th,
        .history-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .history-table th {
            background-color: var(--background-color);
            font-weight: 500;
        }

        /* Enhanced Login Page Styles */
        .login-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary-color) 0%, #1e40af 100%);
            padding: 20px;
        }

        .login-logo {
            width: 150px;
            height: 150px;
            margin-bottom: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            background-color: white;
            padding: 10px;
        }

        .login-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .login-form {
            background-color: var(--card-background);
            padding: 2.5rem;
            border-radius: 15px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            backdrop-filter: blur(10px);
        }

        .login-title {
            text-align: center;
            margin-bottom: 0.5rem;
            color: var(--text-color);
            font-size: 2rem;
            font-weight: 600;
            background: linear-gradient(135deg, var(--primary-color) 0%, #1e40af 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .login-subtitle {
            text-align: center;
            margin-bottom: 2rem;
            color: #64748b;
            font-size: 1rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-color);
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
            transition: all 0.3s ease;
        }

        .form-group input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
            outline: none;
        }

        .login-button {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, var(--primary-color) 0%, #1e40af 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .login-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
        }

        /* Enhanced Dashboard Styles */
        .top-nav {
            background: linear-gradient(135deg, var(--primary-color) 0%, #1e40af 100%);
            color: white;
            padding: 1rem 2rem;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .home-button, .export-button {
            background-color: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .home-button:hover, .export-button:hover {
            background-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .logout-button {
            background-color: rgba(239, 68, 68, 0.9);
            backdrop-filter: blur(5px);
        }

        .logout-button:hover {
            background-color: rgba(220, 38, 38, 0.9);
        }

        .summary-card {
            border-radius: 15px;
            padding: 2rem;
            transition: all 0.3s ease;
        }

        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }

        /* Dark mode enhancements */
        [data-theme="dark"] .login-container {
            background: linear-gradient(135deg, #1e40af 0%, #0f172a 100%);
        }

        [data-theme="dark"] .login-form {
            background-color: rgba(30, 41, 59, 0.9);
            backdrop-filter: blur(10px);
        }

        [data-theme="dark"] .content-section {
            background-color: rgba(30, 41, 59, 0.9);
            backdrop-filter: blur(10px);
        }

        [data-theme="dark"] .summary-card {
            background-color: rgba(30, 41, 59, 0.9);
        }

        /* Add new styles for the chart and features */
        .attendance-chart {
            background-color: var(--card-background);
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            margin: 2rem auto;
            height: 300px;
            width: 100%;
            max-width: 800px;
            border: 1px solid var(--border-color);
        }

        /* Update quick actions */
        .quick-actions {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            margin: 2rem auto;
            max-width: 800px;
            width: 100%;
            flex-wrap: wrap;
        }

        .action-button {
            padding: 1rem 2rem;
            border-radius: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: var(--card-background);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .action-button i {
            font-size: 1.2rem;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--danger-color);
            color: white;
            border-radius: 50%;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .action-button-container {
            position: relative;
        }

        [data-theme="dark"] .action-button {
            background-color: var(--card-background);
        }

        [data-theme="dark"] .action-button:hover {
            background-color: var(--primary-color);
        }

        /* Add new styles for student management */
        .student-actions {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .student-search {
            max-width: 600px;
            margin: 2rem auto;
        }

        .student-search input {
            width: 100%;
            padding: 1rem 1.5rem;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background-color: var(--card-background);
            color: var(--text-color);
        }

        .student-search input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
            outline: none;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal-content {
            background-color: var(--card-background);
            margin: 2rem auto;
            padding: 2rem;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            position: relative;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border-color);
        }

        .modal-content h3 {
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .close {
            position: absolute;
            right: 1rem;
            top: 1rem;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-color);
            background: none;
            border: none;
            padding: 0.5rem;
            line-height: 1;
        }

        .close:hover {
            color: var(--danger-color);
            transform: scale(1.1);
        }

        [data-theme="dark"] .modal-content {
            background-color: var(--card-background);
            border-color: var(--border-color);
        }

        [data-theme="dark"] .modal .student-selection {
            background-color: rgba(255, 255, 255, 0.05);
        }

        [data-theme="dark"] .modal .student-list {
            background-color: var(--card-background);
            border-color: var(--border-color);
        }

        /* Add styles for the students table */
        .students-table {
            margin-top: 20px;
            background-color: var(--card-background);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .students-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .students-table th {
            background-color: var(--primary-color);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 500;
        }

        .students-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .students-table tr:hover {
            background-color: rgba(37, 99, 235, 0.1);
        }

        .student-search {
            margin-bottom: 20px;
        }

        .student-search input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .student-search input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
            outline: none;
        }

        [data-theme="dark"] .students-table tr:hover {
            background-color: rgba(37, 99, 235, 0.2);
        }

        /* Add new styles */
        .student-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin: 2rem auto;
            max-width: 1000px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary-color) 0%, #1e40af 100%);
            color: white;
            padding: 1.8rem;
            border-radius: 15px;
            display: flex;
            align-items: center;
            gap: 1.5rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-card i {
            font-size: 2.5rem;
            opacity: 0.9;
        }

        .stat-info h3 {
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            opacity: 0.9;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            margin: 0;
        }

        .quick-actions {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin: 2rem auto;
            max-width: 800px;
            width: 100%;
            flex-wrap: wrap;
        }

        .action-button {
            padding: 0.8rem 1.5rem;
            min-width: 180px;
            justify-content: center;
            font-size: 0.95rem;
            border-radius: 10px;
            background: var(--card-background);
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .action-button:hover {
            background-color: var(--primary-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] .stat-card {
            background: linear-gradient(135deg, #1e40af 0%, #0f172a 100%);
        }

        /* Responsive adjustments */
        @media (max-width: 1024px) {
            .attendance-summary {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .content-section {
                padding: 1.5rem;
                margin: 1rem;
            }
            
            .attendance-summary {
                grid-template-columns: 1fr;
            }
            
            .device-card {
                flex-direction: column;
                text-align: center;
                gap: 1rem;
            }
            
            .action-button {
                width: 100%;
                justify-content: center;
            }
            
            .quick-actions {
                flex-direction: column;
                align-items: center;
            }
        }

        .batch-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin: 2rem auto;
            max-width: 1000px;
        }

        .batch-filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            align-items: center;
        }

        .batch-filters input,
        .batch-filters select {
            padding: 0.75rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            background-color: var(--card-background);
            color: var(--text-color);
        }

        .batch-filters input {
            flex: 1;
        }

        .student-selection {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .student-list {
            flex: 1;
            height: 200px;
            overflow-y: auto;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 0.5rem;
        }

        .student-list div {
            padding: 0.5rem;
            margin-bottom: 0.25rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .student-list div:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .selection-controls {
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 0.5rem;
        }

        .selection-controls button {
            padding: 0.5rem;
            border: none;
            background: var(--primary-color);
            color: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .selection-controls button:hover {
            background: var(--primary-dark);
        }

        .batches-table {
            background-color: var(--card-background);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .batches-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .batches-table th {
            background: linear-gradient(135deg, var(--primary-color) 0%, #1e40af 100%);
            color: white;
            padding: 1rem 1.5rem;
            text-align: left;
            font-weight: 500;
        }

        .batches-table td {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .batches-table tr:hover td {
            background-color: rgba(59, 130, 246, 0.05);
        }

        .batch-status {
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .batch-status.active {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .batch-status.inactive {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        /* Add new styles for the batch form */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-color);
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
            transition: all 0.3s ease;
            background-color: var(--card-background);
            color: var(--text-color);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
            outline: none;
        }

        .student-list-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .student-list-container h4 {
            margin-bottom: 0.5rem;
            color: var(--text-color);
            font-size: 0.9rem;
        }

        .student-list {
            flex: 1;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 0.5rem;
            overflow-y: auto;
            min-height: 200px;
            max-height: 300px;
            background-color: var(--card-background);
        }

        .student-list div {
            padding: 0.5rem;
            margin-bottom: 0.25rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-color);
        }

        .student-list div:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .student-list div.selected {
            background-color: var(--primary-color);
            color: white;
        }

        .selection-controls {
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 0.5rem;
            padding: 0 1rem;
        }

        .selection-controls button {
            padding: 0.5rem;
            border: none;
            background: var(--primary-color);
            color: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .selection-controls button:hover {
            background: var(--primary-dark);
        }

        /* Update the Live Attendance Styles */
        .attendance-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--card-background);
            border-radius: 12px;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .stat-icon.present {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
        }

        .stat-icon.absent {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
        }

        .stat-icon.total {
            background: rgba(59, 130, 246, 0.1);
            color: var(--primary-color);
        }

        .stat-info h3 {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin: 0;
        }

        .stat-info p {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-color);
            margin: 0.25rem 0 0;
        }

        .attendance-chart {
            background: var(--card-background);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .attendance-filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .search-box {
            flex: 1;
            position: relative;
        }

        .search-box i {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .search-box input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.875rem;
            transition: border-color 0.2s ease;
        }

        .search-box input:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        .filter-options select {
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.875rem;
            background: var(--card-background);
            color: var(--text-color);
            cursor: pointer;
        }

        .attendance-table-container {
            background: var(--card-background);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .attendance-table {
            width: 100%;
            border-collapse: collapse;
        }

        .attendance-table th {
            background: var(--background-color);
            padding: 1rem;
            text-align: left;
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .attendance-table td {
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            font-size: 0.875rem;
        }

        .attendance-table tr:hover {
            background: var(--background-color);
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-badge.present {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
        }

        .status-badge.absent {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
        }

        .action-button {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            background: var(--primary-color);
            color: white;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: background-color 0.2s ease;
        }

        .action-button:hover {
            background: var(--primary-dark);
        }

        .action-button i {
            font-size: 1rem;
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            .stat-card,
            .attendance-chart,
            .attendance-table-container {
                background: var(--dark-card-background);
            }

            .attendance-table th {
                background: var(--dark-background-color);
            }

            .search-box input,
            .filter-options select {
                background: var(--dark-card-background);
                border-color: var(--dark-border-color);
                color: var(--dark-text-color);
            }
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .attendance-filters {
                flex-direction: column;
            }

            .attendance-table {
                display: block;
                overflow-x: auto;
            }

            .stat-card {
                padding: 1rem;
            }

            .stat-icon {
                width: 40px;
                height: 40px;
                font-size: 1.25rem;
            }
        }

        /* Update the Live Attendance Styles */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .header-left h2 {
            margin: 0;
            font-size: 1.5rem;
            color: var(--text-color);
        }

        .subtitle {
            margin: 0.5rem 0 0;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .header-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 1rem;
        }

        .class-info {
            display: flex;
            gap: 1.5rem;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .info-item i {
            color: var(--primary-color);
        }

        .header-actions {
            display: flex;
            gap: 1rem;
        }

        .action-button {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
        }

        .action-button.primary {
            background: var(--primary-color);
            color: white;
        }

        .action-button.secondary {
            background: var(--background-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .action-button:hover {
            transform: translateY(-1px);
        }

        .action-button.primary:hover {
            background: var(--primary-dark);
        }

        .action-button.secondary:hover {
            background: var(--border-color);
        }

        .attendance-overview {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .attendance-stats {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .stat-card {
            background: var(--card-background);
            border-radius: 12px;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-info h3 {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin: 0;
        }

        .stat-info p {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-color);
            margin: 0.25rem 0 0;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .stat-icon.present {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
        }

        .stat-icon.absent {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
        }

        .stat-icon.total {
            background: rgba(59, 130, 246, 0.1);
            color: var(--primary-color);
        }

        .attendance-chart {
            background: var(--card-background);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .chart-header h3 {
            margin: 0;
            font-size: 1rem;
            color: var(--text-color);
        }

        .chart-legend {
            display: flex;
            gap: 1rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .legend-color.present {
            background: var(--success-color);
        }

        .legend-color.absent {
            background: var(--danger-color);
        }

        .attendance-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .search-box {
            flex: 1;
            position: relative;
        }

        .search-box i {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .search-box input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.875rem;
            transition: border-color 0.2s ease;
        }

        .search-box input:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        .filter-options select {
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.875rem;
            background: var(--card-background);
            color: var(--text-color);
            cursor: pointer;
            min-width: 150px;
        }

        .attendance-table-container {
            background: var(--card-background);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .attendance-table {
            width: 100%;
            border-collapse: collapse;
        }

        .attendance-table th {
            background: var(--background-color);
            padding: 1rem;
            text-align: left;
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .attendance-table td {
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            font-size: 0.875rem;
        }

        .attendance-table tr:hover {
            background: var(--background-color);
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-badge.present {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
        }

        .status-badge.absent {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            .stat-card,
            .attendance-chart,
            .attendance-table-container {
                background: var(--dark-card-background);
            }

            .attendance-table th {
                background: var(--dark-background-color);
            }

            .search-box input,
            .filter-options select {
                background: var(--dark-card-background);
                border-color: var(--dark-border-color);
                color: var(--dark-text-color);
            }

            .action-button.secondary {
                background: var(--dark-background-color);
                border-color: var(--dark-border-color);
            }
        }

        /* Responsive adjustments */
        @media (max-width: 1024px) {
            .attendance-overview {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .section-header {
                flex-direction: column;
                gap: 1rem;
            }

            .header-right {
                width: 100%;
                align-items: stretch;
            }

            .class-info {
                justify-content: space-between;
            }

            .header-actions {
                flex-direction: column;
            }

            .attendance-controls {
                flex-direction: column;
            }

            .filter-options select {
                width: 100%;
            }

            .attendance-table {
                display: block;
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <!-- Login Form -->
    <div id="loginPage" class="login-container">
        <div class="login-logo">
            <img src="college_logo.png" alt="College Logo">
        </div>
        <div class="login-form">
            <h2 class="login-title">Presence++</h2>
            <p class="login-subtitle">Smart Attendance System</p>
            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" placeholder="Enter your email">
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" placeholder="Enter your password">
            </div>
            <button class="login-button" onclick="login()">Login</button>
            <div id="loginError" class="error-message"></div>
    </div>
</div>

    <!-- Main Dashboard (hidden by default) -->
    <div id="dashboard" style="display: none;">
        <div id="dashboard">
        <aside class="sidebar">
            <div class="sidebar-header">
                    <div class="header-container">
                        <div class="sidebar-logo">
                            <img src="college_logo.png" alt="College Logo" class="college-logo">
            </div>
                    </div>
                </div>
                <nav class="sidebar-nav">
                    <div class="nav-section">
                        <h4>Main Menu</h4>
                        <a href="#" class="nav-item active" onclick="showSection('liveMonitoring')">
                            <i class="bi bi-wifi"></i>
                            <span>Live Monitoring</span>
                        </a>
                        <a href="#" class="nav-item" onclick="showSection('batches')">
                            <i class="bi bi-collection"></i>
                            <span>Batches</span>
                        </a>
                        <a href="#" class="nav-item" onclick="showSection('students')">
                            <i class="bi bi-people"></i>
                            <span>Students</span>
                        </a>
                        <a href="#" class="nav-item" onclick="showSection('reports')">
                            <i class="bi bi-file-earmark-text"></i>
                            <span>Reports</span>
                        </a>
                        <a href="#" class="nav-item" onclick="showSection('settings')">
                            <i class="bi bi-gear"></i>
                            <span>Settings</span>
                        </a>
                    </div>
                </nav>
            </aside>

            <main class="main-content">
                <header class="top-nav">
                    <div class="button-group">
                        <button class="home-button" onclick="goHome()">
                            <i class="bi bi-house-door"></i>
                            Dashboard
                        </button>
                        <button class="export-button" onclick="exportToExcel()">
                            <i class="bi bi-file-earmark-excel"></i>
                            Export
                        </button>
                    </div>
                    <div class="nav-right">
                        <div class="datetime-display" id="currentDateTime"></div>
                        <button class="logout-button" onclick="logout()">
                            <i class="bi bi-box-arrow-right"></i>
                            Logout
                        </button>
                    </div>
                </header>

                <section id="liveMonitoring" class="content-section">
    <h2>Live Attendance Monitoring</h2>
    
    <!-- ESP32 Status Card -->
    <div class="esp32-status">
        <div class="device-card">
            <div class="device-info">
                <i class="bi bi-wifi status-icon"></i>
                <h3>ESP32 Device Status</h3>
                <p id="esp32Status">Connected</p>
            </div>
            <div class="last-seen">
                <p>Last Updated: <span id="lastUpdateTime">--:--:--</span></p>
            </div>
        </div>
    </div>

    <!-- Real-time Attendance Summary -->
    <div class="attendance-summary">
        <div class="summary-card present">
            <i class="bi bi-person-check-fill"></i>
            <div class="count-info">
                <h3>Present</h3>
                <p id="presentCount">0</p>
            </div>
        </div>
        <div class="summary-card absent">
            <i class="bi bi-person-x-fill"></i>
            <div class="count-info">
                <h3>Absent</h3>
                <p id="absentCount">0</p>
            </div>
        </div>
        <div class="summary-card total">
            <i class="bi bi-people-fill"></i>
            <div class="count-info">
                <h3>Total</h3>
                <p id="totalCount">0</p>
            </div>
        </div>
    </div>

    <!-- Live Students List -->
    <div class="students-list-container">
        <h3>Live Attendance Status</h3>
        <div class="list-filters">
            <button class="filter-btn active" onclick="filterStudents('all')">All</button>
            <button class="filter-btn" onclick="filterStudents('present')">Present</button>
            <button class="filter-btn" onclick="filterStudents('absent')">Absent</button>
        </div>

        <!-- Chart and Quick Actions -->
        <div class="attendance-chart">
            <h3>Attendance Overview</h3>
            <canvas id="attendanceChart"></canvas>
        </div>

        <div class="quick-actions">
            <div class="action-button-container">
                <button class="action-button" onclick="sendReminder()">
                    <i class="bi bi-bell"></i>
                    Send Reminder
                </button>
            </div>
            <div class="action-button-container">
                <button class="action-button" onclick="exportReport()">
                    <i class="bi bi-file-earmark-pdf"></i>
                    Generate Report
                </button>
            </div>
            <div class="action-button-container">
                <button class="action-button" onclick="showNotifications()">
                    <i class="bi bi-bell"></i>
                    Notifications
                    <span class="notification-badge" id="notificationCount">0</span>
                </button>
            </div>
        </div>

        <div class="students-table">
            <table>
                <thead>
                    <tr>
                        <th>Roll No</th>
                        <th>Student Name</th>
                        <th>Status</th>
                        <th>Last Detected</th>
                        <th>MAC Address</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="studentsTableBody">
                    <!-- Students will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>
</section>
            
                <section id="batches" class="content-section" style="display: none;">
                    <h2>Batch Management</h2>
                    
                    <!-- Batch Actions -->
                    <div class="quick-actions">
                        <button class="action-button" onclick="showAddBatchModal()">
                            <i class="bi bi-plus-circle"></i>
                            Add New Batch
                        </button>
                        <button class="action-button" onclick="exportBatchReport()">
                            <i class="bi bi-file-earmark-excel"></i>
                            Export Batch Report
                        </button>
                    </div>

                    <!-- Batch Statistics -->
                    <div class="batch-stats">
                        <div class="stat-card">
                            <i class="bi bi-collection"></i>
                            <div class="stat-info">
                                <h3>Total Batches</h3>
                                <p class="stat-value" id="totalBatches">0</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <i class="bi bi-people"></i>
                            <div class="stat-info">
                                <h3>Total Students</h3>
                                <p class="stat-value" id="totalStudents">0</p>
                            </div>
                        </div>
                        <div class="stat-card">
                        <i class="bi bi-calendar-check"></i>
                            <div class="stat-info">
                                <h3>Active Classes</h3>
                                <p class="stat-value" id="activeClasses">0</p>
                </div>
                        </div>
                    </div>

                    <!-- Batch List -->
                    <div class="batch-list">
                        <div class="batch-filters">
                            <input type="text" id="batchSearch" placeholder="Search batches..." onkeyup="searchBatches()">
                            <select id="batchFilter" onchange="filterBatches()">
                                <option value="all">All Batches</option>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                </div>

                        <div class="batches-table">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Batch ID</th>
                                        <th>Batch Name</th>
                                        <th>Subject</th>
                                        <th>Students</th>
                                        <th>Schedule</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="batchesTableBody">
                                    <!-- Batches will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>
            
                <section id="students" class="content-section" style="display: none;">
                    <h2>Student Management</h2>

                    <!-- Add Statistics Cards -->
                    <div class="student-stats">
                        <div class="stat-card">
                            <i class="bi bi-people-fill"></i>
                            <div class="stat-info">
                                <h3>Total Students</h3>
                                <p class="stat-value">45</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <i class="bi bi-person-check-fill"></i>
                            <div class="stat-info">
                                <h3>Average Attendance</h3>
                                <p class="stat-value">85%</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <i class="bi bi-calendar-check"></i>
                            <div class="stat-info">
                                <h3>Today's Date</h3>
                                <p class="stat-value" id="currentDate">-</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <i class="bi bi-clock"></i>
                            <div class="stat-info">
                                <h3>Current Time</h3>
                                <p class="stat-value" id="currentTime">-</p>
                    </div>
                        </div>
                    </div>

                    <!-- Add Quick Actions -->
                    <div class="quick-actions">
                        <button class="action-button" onclick="downloadCSV()">
                            <i class="bi bi-download"></i>
                            Download CSV
                        </button>
                        <button class="action-button" onclick="printStudentList()">
                            <i class="bi bi-printer"></i>
                            Print List
                        </button>
                        <button class="action-button" onclick="showAttendanceReport()">
                            <i class="bi bi-graph-up"></i>
                            Attendance Report
                        </button>
                    </div>

                    <div class="student-search">
                        <input type="text" id="studentSearch" placeholder="Search by name or roll number..." onkeyup="searchStudents()">
                    </div>

                    <div class="students-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Roll No</th>
                                    <th>Student Name</th>
                                    <th>MAC Address</th>
                                </tr>
                            </thead>
                            <tbody id="studentManagementTableBody">
                                <tr><td>1</td><td>Aditi Mishra</td><td>XX:XX:XX:XX:XX:01</td></tr>
                                <tr><td>2</td><td>Yash Ratnaparkhi</td><td>XX:XX:XX:XX:XX:02</td></tr>
                                <tr><td>3</td><td>Janhavi Molkar</td><td>XX:XX:XX:XX:XX:03</td></tr>
                                <tr><td>4</td><td>Arnav Pangul</td><td>XX:XX:XX:XX:XX:04</td></tr>
                                <tr><td>5</td><td>Mithilesh Bhave</td><td>XX:XX:XX:XX:XX:05</td></tr>
                                <tr><td>6</td><td>Devanshi Kollipara</td><td>XX:XX:XX:XX:XX:06</td></tr>
                                <tr><td>7</td><td>Reva Jaiswal</td><td>XX:XX:XX:XX:XX:07</td></tr>
                                <tr><td>8</td><td>Sanskar Talpelwar</td><td>XX:XX:XX:XX:XX:08</td></tr>
                                <tr><td>10</td><td>Kohana Tripurneni</td><td>XX:XX:XX:XX:XX:09</td></tr>
                                <tr><td>11</td><td>Yash Daryani</td><td>XX:XX:XX:XX:XX:10</td></tr>
                                <tr><td>13</td><td>Tejbeer Singh Kamaljot Singh Anand</td><td>XX:XX:XX:XX:XX:11</td></tr>
                                <tr><td>14</td><td>Veethika Shrivastava</td><td>XX:XX:XX:XX:XX:12</td></tr>
                                <tr><td>15</td><td>Karan Chakole</td><td>XX:XX:XX:XX:XX:13</td></tr>
                                <tr><td>16</td><td>Rinkle Jain</td><td>XX:XX:XX:XX:XX:14</td></tr>
                                <tr><td>17</td><td>Atharva Kewal Korde</td><td>XX:XX:XX:XX:XX:15</td></tr>
                                <tr><td>18</td><td>Dikshant Bhanarkar</td><td>XX:XX:XX:XX:XX:16</td></tr>
                                <tr><td>19</td><td>Harsh Chandrawanshi</td><td>XX:XX:XX:XX:XX:17</td></tr>
                                <tr><td>21</td><td>Aryan Barhanpure</td><td>XX:XX:XX:XX:XX:18</td></tr>
                                <tr><td>23</td><td>Krishna Satpute</td><td>XX:XX:XX:XX:XX:19</td></tr>
                                <tr><td>24</td><td>Shrushti Swamy</td><td>XX:XX:XX:XX:XX:20</td></tr>
                                <tr><td>25</td><td>Sujal Sabhajeet Pal</td><td>XX:XX:XX:XX:XX:21</td></tr>
                                <tr><td>27</td><td>Aastha Dinkar Pardikar</td><td>XX:XX:XX:XX:XX:22</td></tr>
                                <tr><td>29</td><td>Laksh Shende</td><td>XX:XX:XX:XX:XX:23</td></tr>
                                <tr><td>30</td><td>Palak Khubnani</td><td>XX:XX:XX:XX:XX:24</td></tr>
                                <tr><td>31</td><td>Swanandi Kayarkar</td><td>XX:XX:XX:XX:XX:25</td></tr>
                                <tr><td>32</td><td>Shivam Burnwal</td><td>XX:XX:XX:XX:XX:26</td></tr>
                                <tr><td>33</td><td>Amra Khan</td><td>XX:XX:XX:XX:XX:27</td></tr>
                                <tr><td>34</td><td>Nirbhay Shinganjude</td><td>XX:XX:XX:XX:XX:28</td></tr>
                                <tr><td>35</td><td>Pushkar Wankhede</td><td>XX:XX:XX:XX:XX:29</td></tr>
                                <tr><td>36</td><td>Soham Waghmare</td><td>XX:XX:XX:XX:XX:30</td></tr>
                                <tr><td>37</td><td>Komal Manoj Band</td><td>XX:XX:XX:XX:XX:31</td></tr>
                                <tr><td>38</td><td>Rujul Maind</td><td>XX:XX:XX:XX:XX:32</td></tr>
                                <tr><td>39</td><td>Rudra Pradip Bhor</td><td>XX:XX:XX:XX:XX:33</td></tr>
                                <tr><td>40</td><td>Siddharth Dwivedi</td><td>XX:XX:XX:XX:XX:34</td></tr>
                                <tr><td>42</td><td>Swaraj Ramrao Lakhe</td><td>XX:XX:XX:XX:XX:35</td></tr>
                                <tr><td>43</td><td>Anushka Bhongade</td><td>XX:XX:XX:XX:XX:36</td></tr>
                                <tr><td>44</td><td>Vaidehi Bhoyar</td><td>XX:XX:XX:XX:XX:37</td></tr>
                                <tr><td>45</td><td>Mohanish Juware</td><td>XX:XX:XX:XX:XX:38</td></tr>
                                <tr><td>47</td><td>Rucha Yerunkar</td><td>XX:XX:XX:XX:XX:39</td></tr>
                                <tr><td>48</td><td>Jigyasa Khamele</td><td>XX:XX:XX:XX:XX:40</td></tr>
                                <tr><td>49</td><td>Vaishnavi Manohar Wadode</td><td>XX:XX:XX:XX:XX:41</td></tr>
                                <tr><td>50</td><td>Kanak Bais</td><td>XX:XX:XX:XX:XX:42</td></tr>
                                <tr><td>51</td><td>Vedant Chandrashekhar Awari</td><td>XX:XX:XX:XX:XX:43</td></tr>
                                <tr><td>52</td><td>Yash Sumedh Pokle</td><td>XX:XX:XX:XX:XX:44</td></tr>
                                <tr><td>53</td><td>Adwaiti Kankale</td><td>XX:XX:XX:XX:XX:45</td></tr>
                            </tbody>
                        </table>
                    </div>
                </section>
            
                <section id="reports" class="content-section" style="display: none;">
                    <h2>Attendance Reports</h2>
                    <div class="date-range-picker">
                        <div>
                            <label for="startDate">Start Date:</label>
                            <input type="date" id="startDate">
                        </div>
                        <div>
                            <label for="endDate">End Date:</label>
                            <input type="date" id="endDate">
                        </div>
                        <button class="export-button" onclick="exportHistoryToExcel()">
                            <i class="bi bi-file-earmark-excel"></i>
                            Export History
                        </button>
                    </div>
                    <div class="statistics-grid">
                        <div class="stat-card">
                            <h3>Average Attendance</h3>
                            <div class="value" id="avgAttendance">0%</div>
                        </div>
                        <div class="stat-card">
                            <h3>Most Consistent Student</h3>
                            <div class="value" id="mostConsistent">-</div>
                        </div>
                        <div class="stat-card">
                            <h3>Total Classes</h3>
                            <div class="value" id="totalClasses">0</div>
                        </div>
                    </div>
                    <div class="history-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Time</th>
                                    <th>Present</th>
                                    <th>Absent</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody">
                                <!-- History data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </section>
            
                <section id="settings" class="content-section" style="display: none;">
                    <h2>Settings</h2>
                    <div class="settings-form">
                        <div class="form-group">
                            <label for="scanInterval">Scan Interval (seconds)</label>
                            <input type="number" id="scanInterval" min="5" max="300" value="30">
                        </div>
                        <div class="form-group">
                            <label for="timeoutDuration">Device Timeout (minutes)</label>
                            <input type="number" id="timeoutDuration" min="1" max="60" value="5">
                        </div>
                        <div class="form-group">
                            <label for="notificationSound">Notification Sound</label>
                            <select id="notificationSound">
                                <option value="enabled">Enabled</option>
                                <option value="disabled">Disabled</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="darkMode">Theme</label>
                            <select id="darkMode" onchange="toggleDarkMode()">
                                <option value="light">Light Mode</option>
                                <option value="dark">Dark Mode</option>
                            </select>
                        </div>
                        <button class="save-settings" onclick="saveSettings()">Save Settings</button>
                    </div>
                </section>

                <!-- Update the Live Attendance Section -->
                <div id="liveAttendance" class="content-section">
                    <div class="section-header">
                        <div class="header-left">
                            <h2>Live Attendance</h2>
                            <p class="subtitle">Real-time attendance monitoring for your class</p>
                        </div>
                        <div class="header-right">
                            <div class="class-info">
                                <span class="info-item">
                                    <i class="bi bi-calendar"></i>
                                    <span id="currentDate">Loading...</span>
                                </span>
                                <span class="info-item">
                                    <i class="bi bi-clock"></i>
                                    <span id="currentTime">Loading...</span>
                                </span>
                            </div>
                            <div class="header-actions">
                                <button class="action-button secondary" onclick="exportAttendance()">
                                    <i class="bi bi-download"></i>
                                    Export Report
                                </button>
                                <button class="action-button primary" onclick="sendReminder()">
                                    <i class="bi bi-bell"></i>
                                    Send Reminder
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="attendance-overview">
                        <div class="attendance-stats">
                            <div class="stat-card">
                                <div class="stat-info">
                                    <h3>Total Students</h3>
                                    <p id="totalCount">0</p>
                                </div>
                                <div class="stat-icon total">
                                    <i class="bi bi-people"></i>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-info">
                                    <h3>Present</h3>
                                    <p id="presentCount">0</p>
                                </div>
                                <div class="stat-icon present">
                                    <i class="bi bi-person-check"></i>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-info">
                                    <h3>Absent</h3>
                                    <p id="absentCount">0</p>
                                </div>
                                <div class="stat-icon absent">
                                    <i class="bi bi-person-x"></i>
                                </div>
                            </div>
                        </div>

                        <div class="attendance-chart">
                            <div class="chart-header">
                                <h3>Attendance Overview</h3>
                                <div class="chart-legend">
                                    <span class="legend-item">
                                        <span class="legend-color present"></span>
                                        Present
                                    </span>
                                    <span class="legend-item">
                                        <span class="legend-color absent"></span>
                                        Absent
                                    </span>
                                </div>
                            </div>
                            <canvas id="attendanceChart"></canvas>
                        </div>
                    </div>

                    <div class="attendance-controls">
                        <div class="search-box">
                            <i class="bi bi-search"></i>
                            <input type="text" id="searchStudent" placeholder="Search by name or roll number...">
                        </div>
                        <div class="filter-options">
                            <select id="statusFilter">
                                <option value="all">All Students</option>
                                <option value="present">Present Only</option>
                                <option value="absent">Absent Only</option>
                            </select>
                        </div>
                    </div>

                    <div class="attendance-table-container">
                        <table class="attendance-table">
                            <thead>
                                <tr>
                                    <th>Roll No</th>
                                    <th>Student Name</th>
                                    <th>Status</th>
                                    <th>Last Detected</th>
                                    <th>MAC Address</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="studentList">
                                <!-- Student list will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
            </div>

    <!-- Add Batch Modal -->
    <div id="addBatchModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>Create New Batch</h3>
            <form id="addBatchForm">
                <div class="form-group">
                    <label for="batchName">Batch Name</label>
                    <input type="text" id="batchName" placeholder="e.g., B1, B2" required>
                </div>
                <div class="form-group">
                    <label for="batchSubject">Subject</label>
                    <select id="batchSubject" required>
                        <option value="">Select Subject</option>
                        <option value="IOT">IOT</option>
                        <option value="JAVA">JAVA</option>
                        <option value="CWS">CWS</option>
                        <option value="CMOS">CMOS</option>
                        <option value="DSD">DSD</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="batchSchedule">Schedule</label>
                    <input type="text" id="batchSchedule" placeholder="e.g., Mon-Fri, 10:00 AM - 12:00 PM" required>
                </div>
                <div class="form-group">
                    <label for="batchNotes">Notes</label>
                    <textarea id="batchNotes" placeholder="Add any additional information about the batch"></textarea>
                </div>
                <button type="submit" class="action-button">Create Batch</button>
            </form>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAYJOTmOqzFuCWW7Q3lmXzGabq32O_9cZU",
            databaseURL: "https://presence-38724-default-rtdb.firebaseio.com",
            authDomain: "presence-38724.firebaseapp.com",
            projectId: "presence-38724"
        };

        // Initialize Firebase
        let database;
        let auth;
        let isConnected = false;

        function initializeFirebase() {
            try {
                if (!firebase.apps.length) {
                    const app = firebase.initializeApp(firebaseConfig);
                }
                database = firebase.database();
                auth = firebase.auth();
                
                // Check if user is already logged in
                auth.onAuthStateChanged((user) => {
                    if (user) {
                        showDashboard();
                        // Initialize student data if not exists
                        database.ref('esp32_attendance/students').once('value', (snapshot) => {
                            if (!snapshot.exists()) {
                                const initialStudents = {
                                    '1': { name: 'Aditi Mishra', mac_address: 'XX:XX:XX:XX:XX:01', status: 'absent', last_seen: Date.now() },
                                    '2': { name: 'Yash Ratnaparkhi', mac_address: 'XX:XX:XX:XX:XX:02', status: 'absent', last_seen: Date.now() },
                                    '3': { name: 'Janhavi Molkar', mac_address: 'XX:XX:XX:XX:XX:03', status: 'absent', last_seen: Date.now() },
                                    '4': { name: 'Arnav Pangul', mac_address: 'XX:XX:XX:XX:XX:04', status: 'absent', last_seen: Date.now() },
                                    '5': { name: 'Mithilesh Bhave', mac_address: 'XX:XX:XX:XX:XX:05', status: 'absent', last_seen: Date.now() },
                                    '6': { name: 'Devanshi Kollipara', mac_address: 'XX:XX:XX:XX:XX:06', status: 'absent', last_seen: Date.now() },
                                    '7': { name: 'Reva Jaiswal', mac_address: 'XX:XX:XX:XX:XX:07', status: 'absent', last_seen: Date.now() },
                                    '8': { name: 'Sanskar Talpelwar', mac_address: 'XX:XX:XX:XX:XX:08', status: 'absent', last_seen: Date.now() },
                                    '10': { name: 'Kohana Tripurneni', mac_address: 'XX:XX:XX:XX:XX:09', status: 'absent', last_seen: Date.now() },
                                    '11': { name: 'Yash Daryani', mac_address: 'XX:XX:XX:XX:XX:10', status: 'absent', last_seen: Date.now() },
                                    '13': { name: 'Tejbeer Singh Kamaljot Singh Anand', mac_address: 'XX:XX:XX:XX:XX:11', status: 'absent', last_seen: Date.now() },
                                    '14': { name: 'Veethika Shrivastava', mac_address: 'XX:XX:XX:XX:XX:12', status: 'absent', last_seen: Date.now() },
                                    '15': { name: 'Karan Chakole', mac_address: 'XX:XX:XX:XX:XX:13', status: 'absent', last_seen: Date.now() },
                                    '16': { name: 'Rinkle Jain', mac_address: 'XX:XX:XX:XX:XX:14', status: 'absent', last_seen: Date.now() },
                                    '17': { name: 'Atharva Kewal Korde', mac_address: 'XX:XX:XX:XX:XX:15', status: 'absent', last_seen: Date.now() },
                                    '18': { name: 'Dikshant Bhanarkar', mac_address: 'XX:XX:XX:XX:XX:16', status: 'absent', last_seen: Date.now() },
                                    '19': { name: 'Harsh Chandrawanshi', mac_address: 'XX:XX:XX:XX:XX:17', status: 'absent', last_seen: Date.now() },
                                    '21': { name: 'Aryan Barhanpure', mac_address: 'XX:XX:XX:XX:XX:18', status: 'absent', last_seen: Date.now() },
                                    '23': { name: 'Krishna Satpute', mac_address: 'XX:XX:XX:XX:XX:19', status: 'absent', last_seen: Date.now() },
                                    '24': { name: 'Shrushti Swamy', mac_address: 'XX:XX:XX:XX:XX:20', status: 'absent', last_seen: Date.now() },
                                    '25': { name: 'Sujal Sabhajeet Pal', mac_address: 'XX:XX:XX:XX:XX:21', status: 'absent', last_seen: Date.now() },
                                    '27': { name: 'Aastha Dinkar Pardikar', mac_address: 'XX:XX:XX:XX:XX:22', status: 'absent', last_seen: Date.now() },
                                    '29': { name: 'Laksh Shende', mac_address: 'XX:XX:XX:XX:XX:23', status: 'absent', last_seen: Date.now() },
                                    '30': { name: 'Palak Khubnani', mac_address: 'XX:XX:XX:XX:XX:24', status: 'absent', last_seen: Date.now() },
                                    '31': { name: 'Swanandi Kayarkar', mac_address: 'XX:XX:XX:XX:XX:25', status: 'absent', last_seen: Date.now() },
                                    '32': { name: 'Shivam Burnwal', mac_address: 'XX:XX:XX:XX:XX:26', status: 'absent', last_seen: Date.now() },
                                    '33': { name: 'Amra Khan', mac_address: 'XX:XX:XX:XX:XX:27', status: 'absent', last_seen: Date.now() },
                                    '34': { name: 'Nirbhay Shinganjude', mac_address: 'XX:XX:XX:XX:XX:28', status: 'absent', last_seen: Date.now() },
                                    '35': { name: 'Pushkar Wankhede', mac_address: 'XX:XX:XX:XX:XX:29', status: 'absent', last_seen: Date.now() },
                                    '36': { name: 'Soham Waghmare', mac_address: 'XX:XX:XX:XX:XX:30', status: 'absent', last_seen: Date.now() },
                                    '37': { name: 'Komal Manoj Band', mac_address: 'XX:XX:XX:XX:XX:31', status: 'absent', last_seen: Date.now() },
                                    '38': { name: 'Rujul Maind', mac_address: 'XX:XX:XX:XX:XX:32', status: 'absent', last_seen: Date.now() },
                                    '39': { name: 'Rudra Pradip Bhor', mac_address: 'XX:XX:XX:XX:XX:33', status: 'absent', last_seen: Date.now() },
                                    '40': { name: 'Siddharth Dwivedi', mac_address: 'XX:XX:XX:XX:XX:34', status: 'absent', last_seen: Date.now() },
                                    '42': { name: 'Swaraj Ramrao Lakhe', mac_address: 'XX:XX:XX:XX:XX:35', status: 'absent', last_seen: Date.now() },
                                    '43': { name: 'Anushka Bhongade', mac_address: 'XX:XX:XX:XX:XX:36', status: 'absent', last_seen: Date.now() },
                                    '44': { name: 'Vaidehi Bhoyar', mac_address: 'XX:XX:XX:XX:XX:37', status: 'absent', last_seen: Date.now() },
                                    '45': { name: 'Mohanish Juware', mac_address: 'XX:XX:XX:XX:XX:38', status: 'absent', last_seen: Date.now() },
                                    '47': { name: 'Rucha Yerunkar', mac_address: 'XX:XX:XX:XX:XX:39', status: 'absent', last_seen: Date.now() },
                                    '48': { name: 'Jigyasa Khamele', mac_address: 'XX:XX:XX:XX:XX:40', status: 'absent', last_seen: Date.now() },
                                    '49': { name: 'Vaishnavi Manohar Wadode', mac_address: 'XX:XX:XX:XX:XX:41', status: 'absent', last_seen: Date.now() },
                                    '50': { name: 'Kanak Bais', mac_address: 'XX:XX:XX:XX:XX:42', status: 'absent', last_seen: Date.now() },
                                    '51': { name: 'Vedant Chandrashekhar Awari', mac_address: 'XX:XX:XX:XX:XX:43', status: 'absent', last_seen: Date.now() },
                                    '52': { name: 'Yash Sumedh Pokle', mac_address: 'XX:XX:XX:XX:XX:44', status: 'absent', last_seen: Date.now() },
                                    '53': { name: 'Adwaiti Kankale', mac_address: 'XX:XX:XX:XX:XX:45', status: 'absent', last_seen: Date.now() }
                                };
                                database.ref('esp32_attendance/students').set(initialStudents);
                            }
                        });
                    } else {
                        showLogin();
                    }
                });

                // Set up connection state listener
                database.ref('.info/connected').on('value', (snapshot) => {
                    isConnected = snapshot.val() === true;
                    if (isConnected) {
                        console.log('Connected to Firebase');
                        setupFirebaseListeners();
                    }
                });

            } catch (error) {
                console.error('Firebase initialization error:', error);
                document.getElementById('loginError').textContent = 'Error connecting to Firebase';
            }
        }

        function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorElement = document.getElementById('loginError');

            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    showDashboard();
                })
                .catch((error) => {
                    errorElement.textContent = error.message;
                });
        }

        function showDashboard() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('dashboard').style.display = 'flex';
        }

        function showLogin() {
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('dashboard').style.display = 'none';
        }

        // Fix home button
        function goHome() {
            showSection('liveMonitoring');
        }

        // Initialize Firebase when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
        });

        // Function to show different sections
        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.style.display = 'none';
            });
            document.getElementById(sectionId).style.display = 'block';
            
            // Update active nav item
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // Function to setup Firebase listeners
        function setupFirebaseListeners() {
            if (!database) return;

            // Listen for student data changes
            database.ref('esp32_attendance/students').on('value', (snapshot) => {
                const students = snapshot.val();
                console.log('Received students data:', students); // Debug log
                if (students) {
                    updateStudentList(students);
                } else {
                    console.log('No student data found');
                    showNoDataMessage();
                }
            }, (error) => {
                console.error('Error reading from Firebase:', error);
                showErrorMessage(error.message);
            });

            // Listen for settings changes
            database.ref('esp32_attendance/settings').on('value', (snapshot) => {
                const settings = snapshot.val();
                if (settings) {
                    document.getElementById('scanInterval').value = settings.scanInterval;
                    document.getElementById('timeoutDuration').value = settings.timeoutDuration;
                    document.getElementById('notificationSound').value = settings.notificationSound;
                }
            });
        }

        function showNoDataMessage() {
            const tableBody = document.getElementById('studentsTableBody');
            if (tableBody) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 20px;">
                            <div style="color: var(--warning-color);">
                                <i class="bi bi-database" style="font-size: 24px;"></i>
                                <p>No student data available</p>
                                <p>Please check if ESP32 is running and connected</p>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }

        function showErrorMessage(error) {
            const tableBody = document.getElementById('studentsTableBody');
            if (tableBody) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 20px;">
                            <div style="color: var(--danger-color);">
                                <i class="bi bi-exclamation-triangle" style="font-size: 24px;"></i>
                                <p>Error loading data: ${error}</p>
                                <button onclick="initializeFirebase()" class="home-button">
                                    <i class="bi bi-arrow-clockwise"></i>
                                    Retry
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }

        // Function to update the student list
        function updateStudentList(students) {
            if (!isConnected) {
                showNoDataMessage();
                return;
            }

            const tableBody = document.getElementById('studentsTableBody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            let presentCount = 0;
            let absentCount = 0;
            
            Object.entries(students).forEach(([rollNo, student]) => {
                const row = document.createElement('tr');
                
                // Get current date in IST
                const now = new Date();
                const options = {
                    timeZone: 'Asia/Kolkata',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: true
                };

                // Use current time if student is present, otherwise show last seen time
                const timeString = student.status === 'present' ? 
                    now.toLocaleTimeString('en-IN', options) : 
                    'Not Detected';
                
                if (student.status === 'present') presentCount++;
                else absentCount++;
                
                row.innerHTML = `
                    <td>${rollNo}</td>
                    <td>${student.name}</td>
                    <td><span class="status-badge ${student.status}">${student.status.toUpperCase()}</span></td>
                    <td>${timeString}</td>
                    <td>${student.mac_address}</td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // Update summary cards
            document.getElementById('presentCount').textContent = presentCount;
            document.getElementById('absentCount').textContent = absentCount;
            document.getElementById('totalCount').textContent = presentCount + absentCount;
            
            // Update chart
            updateChart(presentCount, absentCount);
            
            // Update last update time with current IST time
            const now = new Date();
            const lastUpdateTime = now.toLocaleTimeString('en-IN', {
                timeZone: 'Asia/Kolkata',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            });
            document.getElementById('lastUpdateTime').textContent = lastUpdateTime;
        }

        // Update the current date and time display function
        function updateDateTime() {
            const now = new Date();
            const options = {
                timeZone: 'Asia/Kolkata',
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            };

            document.getElementById('currentDateTime').textContent = now.toLocaleString('en-IN', options);
            
            // Update student stats section time
            if (document.getElementById('currentDate')) {
                document.getElementById('currentDate').textContent = now.toLocaleDateString('en-IN', {
                    timeZone: 'Asia/Kolkata',
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric'
                });
            }
            
            if (document.getElementById('currentTime')) {
                document.getElementById('currentTime').textContent = now.toLocaleTimeString('en-IN', {
                    timeZone: 'Asia/Kolkata',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: true
                });
            }

            // Also update the student list to keep times current
            if (isConnected && Firebase.ready()) {
                database.ref('esp32_attendance/students').once('value', (snapshot) => {
                    if (snapshot.exists()) {
                        updateStudentList(snapshot.val());
                    }
                });
            }
        }

        // Update more frequently to keep time current
        setInterval(updateDateTime, 1000);
        updateDateTime();

        // Function to export data to Excel
        function exportToExcel() {
            // Get the current student data
            const tableBody = document.getElementById('studentsTableBody');
            const rows = tableBody.getElementsByTagName('tr');
            
            // Create worksheet data
            const worksheetData = [
                ['Roll No', 'Student Name', 'Status', 'Last Detected', 'MAC Address']
            ];
            
            // Add student data
            for (let row of rows) {
                if (row.style.display !== 'none') { // Only include visible rows
                    const cells = row.getElementsByTagName('td');
                    const rowData = [
                        cells[0].textContent,
                        cells[1].textContent,
                        cells[2].textContent,
                        cells[3].textContent,
                        cells[4].textContent
                    ];
                    worksheetData.push(rowData);
                }
            }
            
            // Create workbook and worksheet
            const workbook = XLSX.utils.book_new();
            const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);
            
            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Attendance Data');
            
            // Generate Excel file
            const currentDate = new Date().toISOString().split('T')[0];
            const fileName = `attendance_data_${currentDate}.xlsx`;
            XLSX.writeFile(workbook, fileName);
        }

        // Function to export history to Excel
        function exportHistoryToExcel() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }

            // Get history data from Firebase
            database.ref('esp32_attendance/history')
                .orderByChild('date')
                .startAt(startDate)
                .endAt(endDate)
                .once('value', (snapshot) => {
                    const historyData = snapshot.val();
                    if (!historyData) {
                        alert('No data found for the selected date range');
                        return;
                    }

                    // Create worksheet data
                    const worksheetData = [
                        ['Date', 'Time', 'Present', 'Absent', 'Total']
                    ];

                    // Add history data
                    Object.entries(historyData).forEach(([key, record]) => {
                        worksheetData.push([
                            record.date,
                            record.time,
                            record.present,
                            record.absent,
                            record.total
                        ]);
                    });

                    // Create workbook and worksheet
                    const workbook = XLSX.utils.book_new();
                    const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);
                    
                    // Add worksheet to workbook
                    XLSX.utils.book_append_sheet(workbook, worksheet, 'Attendance History');
                    
                    // Generate Excel file
                    const fileName = `attendance_history_${startDate}_to_${endDate}.xlsx`;
                    XLSX.writeFile(workbook, fileName);
                });
        }

        // Function to toggle dark mode
        function toggleDarkMode() {
            const darkModeSelect = document.getElementById('darkMode');
            const theme = darkModeSelect.value;
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
        }

        // Function to load settings
        function loadSettings() {
            // Load theme preference
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            document.getElementById('darkMode').value = savedTheme;

            // Load other settings from Firebase
            database.ref('esp32_attendance/settings').once('value', (snapshot) => {
                const settings = snapshot.val();
                if (settings) {
                    document.getElementById('scanInterval').value = settings.scanInterval;
                    document.getElementById('timeoutDuration').value = settings.timeoutDuration;
                    document.getElementById('notificationSound').value = settings.notificationSound;
                }
            });
        }

        // Function to save settings
        function saveSettings() {
            const settings = {
                scanInterval: document.getElementById('scanInterval').value,
                timeoutDuration: document.getElementById('timeoutDuration').value,
                notificationSound: document.getElementById('notificationSound').value,
                theme: document.getElementById('darkMode').value
            };

            // Save theme preference to localStorage
            localStorage.setItem('theme', settings.theme);

            // Save other settings to Firebase
            database.ref('esp32_attendance/settings').set(settings)
                .then(() => {
                    alert('Settings saved successfully');
                })
                .catch((error) => {
                    alert('Error saving settings: ' + error.message);
                });
        }

        // Function to update statistics
        function updateStatistics() {
            database.ref('esp32_attendance/history').once('value', (snapshot) => {
                const history = snapshot.val();
                if (history) {
                    let totalPresent = 0;
                    let totalClasses = 0;
                    let studentAttendance = {};

                    Object.values(history).forEach(record => {
                        totalPresent += record.present;
                        totalClasses++;
                        
                        // Update student attendance records
                        if (record.students) {
                            Object.entries(record.students).forEach(([rollNo, status]) => {
                                if (!studentAttendance[rollNo]) {
                                    studentAttendance[rollNo] = { present: 0, total: 0 };
                                }
                                studentAttendance[rollNo].total++;
                                if (status === 'present') {
                                    studentAttendance[rollNo].present++;
                                }
                            });
                        }
                    });

                    // Calculate average attendance
                    const avgAttendance = totalClasses > 0 ? 
                        Math.round((totalPresent / (totalClasses * Object.keys(studentAttendance).length)) * 100) : 0;
                    document.getElementById('avgAttendance').textContent = avgAttendance + '%';

                    // Find most consistent student
                    let mostConsistent = { rollNo: '-', percentage: 0 };
                    Object.entries(studentAttendance).forEach(([rollNo, stats]) => {
                        const percentage = Math.round((stats.present / stats.total) * 100);
                        if (percentage > mostConsistent.percentage) {
                            mostConsistent = { rollNo, percentage };
                        }
                    });
                    document.getElementById('mostConsistent').textContent = 
                        mostConsistent.rollNo !== '-' ? 
                        `Roll No: ${mostConsistent.rollNo} (${mostConsistent.percentage}%)` : '-';

                    // Update total classes
                    document.getElementById('totalClasses').textContent = totalClasses;
                }
            });
        }

        function logout() {
            auth.signOut()
                .then(() => {
                    showLogin();
                })
                .catch((error) => {
                    console.error('Logout error:', error);
                });
        }

        function initializeChart() {
            const ctx = document.getElementById('attendanceChart').getContext('2d');
            const chart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Present', 'Absent'],
                    datasets: [{
                        data: [0, 0],
                        backgroundColor: [
                            'rgba(34, 197, 94, 0.8)',
                            'rgba(239, 68, 68, 0.8)'
                        ],
                        borderColor: [
                            'rgba(34, 197, 94, 1)',
                            'rgba(239, 68, 68, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: {
                                    family: 'Poppins',
                                    size: 12
                                },
                                color: 'var(--text-color)'
                            }
                        }
                    }
                }
            });
            return chart;
        }

        let attendanceChart = null;

        function updateChart(present, absent) {
            if (!attendanceChart) {
                attendanceChart = initializeChart();
            }
            attendanceChart.data.datasets[0].data = [present, absent];
            attendanceChart.update();
        }

        function sendReminder() {
            const absentStudents = Array.from(document.querySelectorAll('.status-badge.absent'))
                .map(badge => badge.closest('tr').querySelector('td:first-child').textContent);
            
            if (absentStudents.length === 0) {
                alert('No absent students to send reminder to');
                return;
            }

            showMessageModal(absentStudents);
        }

        function exportReport() {
            const date = new Date().toLocaleDateString();
            const present = document.getElementById('presentCount').textContent;
            const absent = document.getElementById('absentCount').textContent;
            const total = document.getElementById('totalCount').textContent;
            
            const report = `
                Attendance Report - ${date}
                -------------------------
                Total Students: ${total}
                Present: ${present}
                Absent: ${absent}
                Attendance Rate: ${Math.round((present / total) * 100)}%
            `;
            
            // Create and download the report
            const blob = new Blob([report], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `attendance_report_${date.replace(/\//g, '-')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function showNotifications() {
            const notifications = [
                { type: 'info', message: 'Attendance system is running normally' },
                { type: 'warning', message: 'Low attendance detected' },
                { type: 'success', message: 'All students present' }
            ];
            
            // Update notification badge
            document.getElementById('notificationCount').textContent = notifications.length;
            
            // Show notifications in an alert (in a real implementation, you would use a modal)
            const notificationText = notifications.map(n => `${n.type.toUpperCase()}: ${n.message}`).join('\n');
            alert(notificationText);
        }

        // Initialize chart when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
            attendanceChart = initializeChart();
        });

        // Add new functions for student management
        function showAddStudentForm() {
            document.getElementById('addStudentModal').style.display = 'block';
        }

        function closeAddStudentForm() {
            document.getElementById('addStudentModal').style.display = 'none';
        }

        function addStudent(event) {
            event.preventDefault();
            const rollNo = document.getElementById('newRollNo').value;
            const name = document.getElementById('newStudentName').value;
            const macAddress = document.getElementById('newMacAddress').value;

            // Add student to Firebase
            database.ref(`esp32_attendance/students/${rollNo}`).set({
                name: name,
                mac_address: macAddress,
                status: 'absent',
                last_seen: Date.now()
            }).then(() => {
                alert('Student added successfully');
                closeAddStudentForm();
                loadStudentManagementTable();
            }).catch(error => {
                alert('Error adding student: ' + error.message);
            });
        }

        function loadStudentManagementTable() {
            database.ref('esp32_attendance/students').on('value', (snapshot) => {
                const students = snapshot.val();
                const tableBody = document.getElementById('studentManagementTableBody');
                tableBody.innerHTML = '';

                if (students) {
                    Object.entries(students).forEach(([rollNo, student]) => {
                        const row = document.createElement('tr');
                        const lastSeen = new Date(parseInt(student.last_seen));
                        const timeString = lastSeen.toLocaleTimeString('en-US', {
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit',
                            hour12: true
                        });

                        row.innerHTML = `
                            <td>${rollNo}</td>
                            <td>${student.name}</td>
                            <td><span class="status-badge ${student.status}">${student.status.toUpperCase()}</span></td>
                            <td>${student.mac_address}</td>
                            <td>${timeString}</td>
                        `;
                        tableBody.appendChild(row);
                    });
                } else {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 20px;">
                                <div style="color: var(--warning-color);">
                                    <i class="bi bi-database" style="font-size: 24px;"></i>
                                    <p>No student data available</p>
                                </div>
                            </td>
                        </tr>
                    `;
                }
            });
        }

        function searchStudents() {
            const searchText = document.getElementById('studentSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#studentManagementTableBody tr');

            rows.forEach(row => {
                const name = row.cells[1].textContent.toLowerCase();
                const rollNo = row.cells[0].textContent.toLowerCase();
                if (name.includes(searchText) || rollNo.includes(searchText)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function exportStudentList() {
            const tableBody = document.getElementById('studentManagementTableBody');
            const rows = tableBody.getElementsByTagName('tr');
            
            const worksheetData = [
                ['Roll No', 'Student Name', 'Status', 'MAC Address', 'Last Detected']
            ];
            
            for (let row of rows) {
                if (row.style.display !== 'none') {
                    const cells = row.getElementsByTagName('td');
                    const rowData = [
                        cells[0].textContent,
                        cells[1].textContent,
                        cells[2].textContent,
                        cells[3].textContent,
                        cells[4].textContent
                    ];
                    worksheetData.push(rowData);
                }
            }
            
            const workbook = XLSX.utils.book_new();
            const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Student List');
            
            const fileName = `student_list_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(workbook, fileName);
        }

        // Add new functions
        function downloadCSV() {
            const rows = document.querySelectorAll('#studentManagementTableBody tr');
            let csv = 'Roll No,Student Name,MAC Address\n';
            
            rows.forEach(row => {
                if (row.style.display !== 'none') {
                    const cells = row.getElementsByTagName('td');
                    csv += `${cells[0].textContent},"${cells[1].textContent}",${cells[2].textContent}\n`;
                }
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `student_list_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function printStudentList() {
            window.print();
        }

        function showAttendanceReport() {
            alert('Generating attendance report...\nThis feature will show detailed attendance statistics and trends.');
        }

        // Update date and time every second
        setInterval(updateDateTime, 1000);
        updateDateTime();

        // Update the function that formats time for the students table
        function formatTime(timestamp) {
            const date = new Date(parseInt(timestamp));
            return date.toLocaleTimeString('en-IN', {
                timeZone: 'Asia/Kolkata',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            });
        }

        // Add Gmail API script
        const gmailScript = document.createElement('script');
        gmailScript.src = 'https://apis.google.com/js/api.js';
        gmailScript.onload = () => {
            gapi.load('client:auth2', initGmailClient);
        };
        document.head.appendChild(gmailScript);

        // Initialize Gmail client
        function initGmailClient() {
            gapi.client.init({
                apiKey: 'AIzaSyAYJOTmOqzFuCWW7Q3lmXzGabq32O_9cZU', // Your Firebase API key
                clientId: 'YOUR_CLIENT_ID', // Replace with your OAuth client ID
                discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest'],
                scope: 'https://www.googleapis.com/auth/gmail.send'
            }).then(() => {
                console.log('Gmail API initialized');
                // Check if user is already signed in
                if (gapi.auth2.getAuthInstance().isSignedIn.get()) {
                    console.log('User is already signed in');
                } else {
                    // Sign in the user
                    gapi.auth2.getAuthInstance().signIn();
                }
            }).catch(error => {
                console.error('Error initializing Gmail API:', error);
            });
        }

        // Update the sendMessageToStudents function to use Gmail
        async function sendMessageToStudents(rollNumbers, message) {
            if (!rollNumbers || rollNumbers.length === 0) {
                alert('Please select at least one student');
                return;
            }

            if (!message || message.trim() === '') {
                alert('Please enter a message');
                return;
            }

            try {
                // Ensure user is signed in
                if (!gapi.auth2.getAuthInstance().isSignedIn.get()) {
                    await gapi.auth2.getAuthInstance().signIn();
                }

                // Get student emails from Firebase
                const studentsSnapshot = await database.ref('esp32_attendance/students').once('value');
                const students = studentsSnapshot.val();
                
                // Filter students by roll numbers and get their emails
                const recipients = rollNumbers.map(rollNo => {
                    const student = students[rollNo];
                    return student.email;
                }).filter(email => email);

                if (recipients.length === 0) {
                    alert('No valid email addresses found for selected students');
                    return;
                }

                // Create email content
                const emailContent = [
                    'From: Presence++ Attendance System <your-email@gmail.com>',
                    'To: ' + recipients.join(', '),
                    'Subject: Attendance Notification',
                    'Content-Type: text/html; charset=utf-8',
                    '',
                    `<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
                        <h2 style="color: #2563eb;">Presence++ Attendance Notification</h2>
                        <p>${message}</p>
                        <hr style="border: 1px solid #e2e8f0;">
                        <p style="color: #64748b; font-size: 12px;">This is an automated message from the Presence++ Attendance System.</p>
                    </div>`
                ].join('\n');

                // Encode email content
                const encodedEmail = btoa(emailContent)
                    .replace(/\+/g, '-')
                    .replace(/\//g, '_')
                    .replace(/=+$/, '');

                // Send email using Gmail API
                const response = await gapi.client.gmail.users.messages.send({
                    userId: 'me',
                    resource: {
                        raw: encodedEmail
                    }
                });

                // Store message in Firebase
                const messageData = {
                    timestamp: Date.now(),
                    message: message,
                    recipients: rollNumbers,
                    emailIds: recipients,
                    status: 'sent',
                    gmailMessageId: response.result.id
                };

                await database.ref('esp32_attendance/messages').push(messageData);
                alert(`Message sent to ${recipients.length} students`);

            } catch (error) {
                console.error('Error sending message:', error);
                if (error.status === 403) {
                    alert('Please authorize the Gmail API access');
                    gapi.auth2.getAuthInstance().signIn();
                } else {
                    alert('Error sending message: ' + error.message);
                }
            }
        }

        // Add email field to student data structure
        function initializeStudentData() {
            database.ref('esp32_attendance/students').once('value', (snapshot) => {
                if (!snapshot.exists()) {
                    const initialStudents = {
                        '1': { 
                            name: 'Aditi Mishra', 
                            mac_address: 'XX:XX:XX:XX:XX:01', 
                            status: 'absent', 
                            last_seen: Date.now(),
                            email: 'aditi.mishra@example.com'
                        },
                        // ... other students with email fields
                    };
                    database.ref('esp32_attendance/students').set(initialStudents);
                }
            });
        }

        // Add a function to update student emails
        function updateStudentEmail(rollNo, email) {
            database.ref(`esp32_attendance/students/${rollNo}/email`).set(email)
                .then(() => {
                    console.log(`Email updated for student ${rollNo}`);
                })
                .catch(error => {
                    console.error('Error updating email:', error);
                });
        }

        function showMessageModal(rollNumbers) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                    <h3>Send Message</h3>
                    <div class="form-group">
                        <label for="messageText">Message:</label>
                        <textarea id="messageText" rows="4" placeholder="Enter your message here..."></textarea>
                    </div>
                    <button class="action-button" onclick="sendMessageToStudents(['${rollNumbers.join("','")}'], document.getElementById('messageText').value); this.parentElement.parentElement.remove()">
                        <i class="bi bi-send"></i>
                        Send Message
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Add styles for the message modal
        const style = document.createElement('style');
        style.textContent = `
            .modal {
                display: block;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
                z-index: 1000;
            }

            .modal-content {
                background-color: var(--card-background);
                margin: 15% auto;
                padding: 2rem;
                border-radius: 15px;
                width: 90%;
                max-width: 500px;
                position: relative;
            }

            .modal-content textarea {
                width: 100%;
                padding: 1rem;
                border: 2px solid var(--border-color);
                border-radius: 8px;
                font-family: 'Poppins', sans-serif;
                resize: vertical;
                margin-bottom: 1rem;
            }

            .modal-content .close {
                position: absolute;
                right: 1rem;
                top: 1rem;
                font-size: 1.5rem;
                cursor: pointer;
                color: var(--text-color);
            }

            .modal-content .close:hover {
                color: var(--danger-color);
            }

            [data-theme="dark"] .modal-content {
                background-color: var(--card-background);
            }
        `;
        document.head.appendChild(style);

        // Batch management functions
        function showAddBatchModal() {
            document.getElementById('addBatchModal').style.display = 'block';
            loadAvailableStudents();
        }

        function closeAddBatchModal() {
            document.getElementById('addBatchModal').style.display = 'none';
        }

        function loadAvailableStudents() {
            database.ref('esp32_attendance/students').once('value', (snapshot) => {
                const students = snapshot.val();
                const availableStudentsDiv = document.getElementById('availableStudents');
                availableStudentsDiv.innerHTML = '';

                if (students) {
                    Object.entries(students).forEach(([rollNo, student]) => {
                        const div = document.createElement('div');
                        div.textContent = `${rollNo} - ${student.name}`;
                        div.setAttribute('data-rollno', rollNo);
                        div.onclick = () => toggleStudentSelection(div);
                        availableStudentsDiv.appendChild(div);
                    });
                }
            });
        }

        function toggleStudentSelection(element) {
            element.classList.toggle('selected');
        }

        function moveSelected(from, to) {
            const fromList = document.getElementById(from + 'Students');
            const toList = document.getElementById(to + 'Students');
            const selected = fromList.querySelectorAll('.selected');

            selected.forEach(element => {
                element.classList.remove('selected');
                toList.appendChild(element);
            });
        }

        function addBatch() {
            const modal = document.getElementById('addBatchModal');
            if (modal) {
                modal.style.display = 'block';
            }
        }

        // Update the close modal functionality
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.close').forEach(closeBtn => {
                closeBtn.onclick = function() {
                    const modal = this.closest('.modal');
                    if (modal) {
                        modal.style.display = 'none';
                    }
                }
            });
        });

        // Update the form submission handler
        document.getElementById('addBatchForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const batchName = document.getElementById('batchName').value;
            const subject = document.getElementById('batchSubject').value;
            const schedule = document.getElementById('batchSchedule').value;
            const notes = document.getElementById('batchNotes').value;
            
            try {
                const batchRef = ref(database, 'esp32_attendance/batches');
                const newBatchRef = push(batchRef);
                
                await set(newBatchRef, {
                    name: batchName,
                    subject: subject,
                    schedule: schedule,
                    notes: notes,
                    status: 'active',
                    createdAt: serverTimestamp()
                });
                
                // Close modal and reset form
                document.getElementById('addBatchModal').style.display = 'none';
                this.reset();
                
                // Show success message
                alert('Batch created successfully!');
                
                // Refresh batch list
                loadBatches();
            } catch (error) {
                console.error('Error creating batch:', error);
                alert('Error creating batch. Please try again.');
            }
        });

        function loadBatches() {
            database.ref('esp32_attendance/batches').on('value', (snapshot) => {
                const batches = snapshot.val();
                const tableBody = document.getElementById('batchesTableBody');
                tableBody.innerHTML = '';

                if (batches) {
                    let totalStudents = 0;
                    let activeClasses = 0;

                    Object.entries(batches).forEach(([batchId, batch]) => {
                        const row = document.createElement('tr');
                        totalStudents += batch.students.length;
                        if (batch.status === 'active') activeClasses++;

                        row.innerHTML = `
                            <td>${batchId.substring(0, 8)}</td>
                            <td>${batch.name}</td>
                            <td>${batch.subject}</td>
                            <td>${batch.students.length}</td>
                            <td>${batch.schedule}</td>
                            <td><span class="batch-status ${batch.status}">${batch.status}</span></td>
                            <td>
                                <button class="action-button" onclick="viewBatchDetails('${batchId}')">
                                    <i class="bi bi-eye"></i>
                                    View
                                </button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });

                    document.getElementById('totalBatches').textContent = Object.keys(batches).length;
                    document.getElementById('totalStudents').textContent = totalStudents;
                    document.getElementById('activeClasses').textContent = activeClasses;
                }
            });
        }

        function searchBatches() {
            const searchText = document.getElementById('batchSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#batchesTableBody tr');

            rows.forEach(row => {
                const batchName = row.cells[1].textContent.toLowerCase();
                const batchId = row.cells[0].textContent.toLowerCase();
                if (batchName.includes(searchText) || batchId.includes(searchText)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function filterBatches() {
            const filter = document.getElementById('batchFilter').value;
            const rows = document.querySelectorAll('#batchesTableBody tr');

            rows.forEach(row => {
                const status = row.cells[4].textContent.toLowerCase();
                if (filter === 'all' || status === filter) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function exportBatchReport() {
            const workbook = XLSX.utils.book_new();
            const worksheet = XLSX.utils.aoa_to_sheet([
                ['Batch ID', 'Batch Name', 'Subject', 'Students', 'Schedule', 'Status']
            ]);

            database.ref('esp32_attendance/batches').once('value', (snapshot) => {
                const batches = snapshot.val();
                if (batches) {
                    Object.entries(batches).forEach(([batchId, batch]) => {
                        XLSX.utils.sheet_add_aoa(worksheet, [[
                            batchId.substring(0, 8),
                            batch.name,
                            batch.subject,
                            batch.students.length,
                            batch.schedule,
                            batch.status
                        ]], { origin: -1 });
                    });
                }

                XLSX.utils.book_append_sheet(workbook, worksheet, 'Batch Report');
                XLSX.writeFile(workbook, `batch_report_${new Date().toISOString().split('T')[0]}.xlsx`);
            });
        }

        // Initialize batch management when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            loadBatches();
        });

        // Add function to view batch details
        function viewBatchDetails(batchId) {
            database.ref(`esp32_attendance/batches/${batchId}`).once('value', (snapshot) => {
                const batch = snapshot.val();
                if (batch) {
                    const modal = document.createElement('div');
                    modal.className = 'modal';
                    modal.innerHTML = `
                        <div class="modal-content">
                            <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                            <h3>Batch Details</h3>
                            <div class="batch-details">
                                <p><strong>Batch Name:</strong> ${batch.name}</p>
                                <p><strong>Subject:</strong> ${batch.subject}</p>
                                <p><strong>Schedule:</strong> ${batch.schedule}</p>
                                <p><strong>Status:</strong> ${batch.status}</p>
                                <p><strong>Notes:</strong> ${batch.notes || 'No notes available'}</p>
                                <p><strong>Total Students:</strong> ${batch.students.length}</p>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                }
            });
        }
    </script>
</body>
</html>